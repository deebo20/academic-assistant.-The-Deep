<!doctype html>
<html lang="ar">
  <head>
    <meta charset="utf-8" />
    <title>ูุณุงุนุฏ ุงูุทูุงุจ ูุงููุนูููู</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; direction: rtl; background:#fafafa; }
      h1 { font-size: 22px; }
      .row { display:flex; gap:12px; flex-wrap: wrap; }
      .col { flex:1; min-width: 260px; }
      label { display:block; margin:10px 0 6px; font-weight:600; }
      select, input[type="file"], textarea, button { width:100%; padding:10px; font-size:14px; }
      textarea { height:120px; }
      .chat { border:1px solid #ddd; background:#fff; padding:12px; border-radius:8px; height:360px; overflow:auto; }
      .msg { margin:8px 0; }
      .you { text-align:right; }
      .ai { background:#f5f7ff; border-radius:8px; padding:8px; }
      .out { white-space: pre-wrap; }
      .controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
      .small { font-size:12px; color:#666; }
      .hidden { display:none; }
    </style>
  </head>
  <body>
    <h1>ูุณุงุนุฏ ุฃูุงุฏููู ุฐูู โ ุดุงุช + ุตูุฑุฉ + ุตูุช</h1>

    <div class="row">
      <div class="col">
        <label>ุงูุฏูุฑ</label>
        <select id="role">
          <option value="Student">ุทุงูุจ</option>
          <option value="Teacher">ูุนูู</option>
        </select>

        <label>ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ</label>
        <select id="grade">
          <option>ุงุจุชุฏุงุฆู</option>
          <option>ุฅุนุฏุงุฏู</option>
          <option>ุซุงููู</option>
        </select>

        <label>ุงุฑูุน ุตูุฑุฉ ุงูุณุคุงู (ุงุฎุชูุงุฑู)</label>
        <input type="file" id="img" accept="image/*" />

        <label>ุฑุณุงูุฉ ูุตูุฉ ูู ุงูุดุงุช</label>
        <textarea id="text" placeholder="ุงูุชุจ ุณุคุงูู ููุง..."></textarea>

        <div class="controls">
          <button id="record">๐ค ุชุณุฌูู ุตูุช</button>
          <span id="recstatus" class="small">ุบูุฑ ูุดุท</span>
        </div>

        <div class="controls">
          <button id="send">ุฅุฑุณุงู</button>
          <button id="clear">ูุณุญ ุงููุญุงุฏุซุฉ</button>
        </div>

        <p class="small">ููุญูุธุฉ: ูู ุงุณุชุฎุฏูุช ุงูุตูุชุ ููุญูููู ููุต ููุฑุณูู ูุฑุณุงูุฉ ุดุงุช.</p>
      </div>

      <div class="col">
        <label>ุงููุญุงุฏุซุฉ</label>
        <div id="chat" class="chat"></div>
      </div>
    </div>

    <script>
      // ุถุน ููุชุงุญู ููุง ูุคูุชูุง ุฃุซูุงุก ุงูุชุฌุฑุจุฉ ููุท. ูุง ุชููุดุฑ ุงูููุชุงุญ ุนูููุง.
      const API_KEY = "PUT_YOUR_API_KEY_HERE"; // ุงุณุชุจุฏููุง ุจููุชุงุญู
      const MODEL = "gemini-1.5-flash"; // ุณุฑูุน ููุฌุงูู ุบุงูุจูุง ููุงุณุชุฎุฏุงู ุงููุญุฏูุฏ

      function addMsg(text, who="ai") {
        const chat = document.getElementById('chat');
        const d = document.createElement('div');
        d.className = 'msg ' + (who === 'you' ? 'you' : 'ai');
        d.innerHTML = '<div class="out">' + text.replace(/</g,"&lt;") + '</div>';
        chat.appendChild(d);
        chat.scrollTop = chat.scrollHeight;
      }

      async function fileToInlineData(file) {
        const buf = await file.arrayBuffer();
        const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        return { inline_data: { mime_type: file.type, data: b64 } };
      }

      async function sendMessage() {
        const role = document.getElementById('role').value;
        const grade = document.getElementById('grade').value;
        const text = document.getElementById('text').value.trim();
        const imgFile = document.getElementById('img').files[0];

        if (!text && !imgFile && !lastTranscribed) {
          addMsg("ูู ูุถูู ุงูุชุจ ุฑุณุงูุฉ ุฃู ุงุฑูุน ุตูุฑุฉ ุฃู ุณุฌูู ุตูุช.", "ai");
          return;
        }

        const userText = (text || lastTranscribed || "").trim();
        lastTranscribed = "";

        addMsg((userText || "[ุตูุฑุฉ ููุท ุจุฏูู ูุต]"), "you");

        const systemPrompt = `
ุฃููุง ุฃูุง ุงููุณุงุนุฏ ุงูุฎุงุต ุจูู ๐
ุฃูุง ููุง ุนูุดุงู ุฃุณุงุนุฏู ุณูุงุก ููุช ุทุงูุจ ุฃู ูุนููุ ูููุงู ุฃูุฏุฑ ุฃุชููู ูุนุงู ูู ุฃู ููุถูุน ุนุงู.
ูููุฒุงุชู: ูุฑุงุกุฉ ุฃุณุฆูุฉ ูู ุงูุตูุฑุ ููู ุฑุณุงุฆู ุงูุดุงุชุ ุชุญููู ุงูุตูุช ุฅูู ูุตุ ุดุฑุญ ุฎุทูุฉ ุจุฎุทูุฉุ ููุฎุต ูููุนููุ ูุตุงุฆุญุ ุฃุฎุทุงุก ุดุงุฆุนุฉุ ุชูุงุฑูู ูุดุงุจูุฉุ ุชุฎุตูุต ุญุณุจ ุงููุฑุญูุฉ.
ุงูููุงุนุฏ:
1) ูู ุงููุฏุฎู ุตูุฑุฉ: ุงุณุชุฎุฑุฌ ูุต ุงูุณุคุงู ูุญุฏุฏ ููุนูุ ูุชุญูู ูู ุงููุถูุญ.
2) ูู ุงููุฏุฎู ูุต/ุตูุช: ุงุนุชุจุฑู ุณุคุงู ูู ุงูุดุงุช.
3) ุณูุงุณุฉ ุงูุญู:
- Teacher: ููุฎุต ุณุฑูุน + ููุงุท ุฑุฆูุณูุฉ + ุฃุฎุทุงุก ุดุงุฆุนุฉ + ุจุฏุงุฆู.
- Student: ุดุฑุญ ุชุฏุฑูุฌู ุณุคุงู-ุฌูุงุจ ูุชุนุฒูุฒ ุงูููู ูููุณ ุงููุณุฎ.
- ุฎุตูุต ุงูุฃุณููุจ ุญุณุจ ุงููุฑุญูุฉ: ${grade}.
4) ุงูุฅุฎุฑุงุฌ:
- "ูุต ุงูุณุคุงู ุงููุณุชุฎุฑุฌ" ุฅู ููุฌุฏ.
- ุฑูุงุถูุงุช: ุฎุทูุงุช + LaTeX + "ุงูุฎูุงุตุฉ".
- ุบูุฑ ุฑูุงุถูุงุช: ุฎุทูุงุช ููู + ููุงููู + ุงูุญู ุงูููุงุฆู.
- "ูุตุงุฆุญ" + "ุฃุฎุทุงุก ุดุงุฆุนุฉ" + "ุชูุฑูู ูุดุงุจู".
5) ุงูุญูุงุฌุฒ:
- ูู ุทุงูุจ ูุทูุจ ุงูุฅุฌุงุจุฉ ุงูููุงุฆูุฉ ููุท: ุงุฑูุถ ุฅุนุทุงุกูุง ูุญุฏูุง ููุฏูููุง ูุน ุดุฑุญ ูุตูุฑ ุนูู ุงูุฃูู.
- ูู ุงููุฏุฎู ุบูุฑ ูุงูู ุฃู ููู ุฃุณุฆูุฉ ูุชุนุฏุฏุฉ: ุงุทูุจ ุงูุชุญุฏูุฏ.
6) ุงูุฃุณููุจ:
- ุงุฌุนู ุงูุนูุงููู ูุตูุฑุฉ ููุงุถุญุฉ.
- ูู ุณุทุฑ ูุถูู ูุนูููุฉ ุฌุฏูุฏุฉ ุฏูู ุชูุฑุงุฑ.
ุงูุฏูุฑ ุงูุญุงูู: ${role}.
`;

        const parts = [{ text: systemPrompt }];
        if (userText) parts.push({ text: "ุณุคุงู ุงููุณุชุฎุฏู: " + userText });
        if (imgFile) parts.push(await fileToInlineData(imgFile));

        try {
          const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts }] })
          });
          const data = await resp.json();
          const textOut = data?.candidates?.[0]?.content?.parts?.map(p => p.text).join("\n") || "ูุง ููุฌุฏ ุฑุฏ. ุชุฃูุฏ ูู ุงูุฅุนุฏุงุฏุงุช.";
          addMsg(textOut, "ai");
        } catch (e) {
          addMsg("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงููููุฐุฌ. ุชุฃูุฏ ูู ุงูููุชุงุญ ูุงูุงุชุตุงู.", "ai");
        }

        document.getElementById('text').value = "";
        document.getElementById('img').value = "";
      }

      document.getElementById('send').onclick = sendMessage;
      document.getElementById('clear').onclick = () => document.getElementById('chat').innerHTML = "";

      // ุชุณุฌูู ุตูุช ุจุณูุท: ูุญูู ุงูุตูุช ุฅูู ูุต ุจุงุณุชุฎุฏุงู ูุชุตูุญ ูุฑูู (SpeechRecognition)
      let rec;
      let lastTranscribed = "";
      const recBtn = document.getElementById('record');
      const recStatus = document.getElementById('recstatus');

      function initSpeech() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { recStatus.textContent = "ุงูููุฒุฉ ุบูุฑ ูุฏุนููุฉ ูู ูุฐุง ุงููุชุตูุญ."; return null; }
        const r = new SR();
        r.lang = "ar-EG"; // ุนุฑุจู ูุตุฑ
        r.interimResults = true;
        r.continuous = false;
        r.onstart = () => recStatus.textContent = "ูุณุฌูู...";
        r.onend = () => recStatus.textContent = "ุชูููู ุงูุชุณุฌูู";
        r.onerror = (e) => recStatus.textContent = "ุฎุทุฃ ูู ุงูุชุณุฌูู: " + e.error;
        r.onresult = (ev) => {
          let transcript = "";
          for (const res of ev.results) transcript += res[0].transcript;
          lastTranscribed = transcript;
          document.getElementById('text').value = transcript;
        };
        return r;
      }

      recBtn.onclick = () => {
        if (!rec) rec = initSpeech();
        if (!rec) return;
        rec.start();
      };
    </script>
  </body>
</html>
